<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Animal Food Dashboard</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #f4f7fa;
      }
      .top-bar {
        background: linear-gradient(90deg, #ff9800, #f57c00);
        color: white;
        padding: 16px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .top-bar h1 {
        margin: 0;
        font-size: 24px;
      }
      .top-bar .logout {
        background: white;
        color: #f57c00;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }
      @media (min-width: 768px) {
        .container {
          padding: 40px;
        }
      }
      @media (min-width: 1024px) {
        .container {
          padding: 60px;
        }
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 24px;
        border-bottom: 2px solid #ccc;
      }
      .tabs button {
        background: white;
        border: none;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 14px;
        border-radius: 8px 8px 0 0;
        transition: background 0.3s;
      }
      .tabs button.active {
        background: #ff9800;
        color: white;
      }
      .tab-content {
        display: none;
        background: white;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .tab-content.active {
        display: block;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      form label {
        display: flex;
        flex-direction: column;
        font-weight: bold;
      }
      form input,
      form select {
        margin-top: 4px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      form button {
        background: #ff9800;
        color: white;
        border: none;
        padding: 12px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      form button:hover {
        background: #f57c00;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      table thead {
        background: #ff9800;
        color: white;
      }
      table th,
      table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      table tbody tr:hover {
        background: #f1f1f1;
      }
      .reverted-field {
        color: #888 !important;
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <h1>Animal Food Dashboard</h1>
      <button class="logout" onclick="logout()">Logout</button>
    </div>

    <div class="container">
      <div class="tabs">
        <button class="active" onclick="openTab(event, 'purchases')">
          Purchases
        </button>
        <button onclick="openTab(event, 'history')">History</button>
        <button onclick="openTab(event, 'stock')">ðŸŒ¾ Stock</button>
      </div>

      <!-- Purchases Tab -->
      <div id="purchases" class="tab-content active">
        <h2>Purchase Rice</h2>
        <form id="purchase-form">
          <label>
            Purchase From Type
            <select name="sourceType" id="source-type" required>
              <option value="">Select Source Type</option>
              <option value="Miller">Miller</option>
              <option value="Wholesaler">Wholesaler</option>
            </select>
          </label>
          <label>
            Select Supplier
            <select name="supplierId" id="supplier-select" required>
              <option value="">First select source type</option>
            </select>
          </label>
          <label>
            Rice Type
            <select name="riceType" required>
              <option value="">Select Rice Type</option>
              <option value="White Rice">White Rice</option>
              <option value="Red Rice">Red Rice</option>
              <option value="Samba">Samba</option>
              <option value="Basmati">Basmati</option>
              <option value="Keeri Samba">Keeri Samba</option>
            </select>
          </label>
          <label>
            Quantity (kg)
            <input type="number" name="quantity" step="0.01" required />
          </label>
          <label>
            Price (per kg)
            <input type="number" name="price" step="0.01" />
          </label>
          <button type="submit">Purchase Rice</button>
        </form>

        <h2 style="margin-top: 40px">Recent Transactions</h2>
        <table id="recent-purchases-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Party</th>
              <th>Rice Type</th>
              <th>Quantity (kg)</th>
              <th>Price (per kg)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Damage feature removed -->

      <!-- History Tab -->
      <div id="history" class="tab-content">
        <h2>Transaction History</h2>
        <table id="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Party</th>
              <th>Type</th>
              <th>Quantity (kg)</th>
              <th>Price (per kg)</th>
              <th>Block ID</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Stock Tab -->
      <div id="stock" class="tab-content">
        <h2>ðŸŒ¾ Rice Stock</h2>
        <table id="stock-table">
          <thead>
            <tr>
              <th>Rice Type</th>
              <th>Quantity (kg)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal for viewing transaction details -->
    <div
      id="transactionModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        "
      >
        <h2>Transaction Details</h2>
        <div
          id="transactionDetails"
          style="margin: 20px 0; font-size: 14px; line-height: 1.8"
        >
          <!-- Details will be populated here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button
            class="logout"
            onclick="closeTransactionModal()"
            style="background: #ff9800; color: white"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- OTP Verification Modal -->
    <div
      id="otp-modal"
      class="modal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        class="modal-content"
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        "
      >
        <h3>Verify OTP</h3>
        <p>
          Enter the OTP sent to
          <strong>****<span id="otp-phone-digits"></span></strong>
        </p>
        <form id="otp-form">
          <label
            style="
              display: flex;
              flex-direction: column;
              font-weight: bold;
              margin: 16px 0;
            "
          >
            OTP
            <input
              type="password"
              id="otp-input"
              placeholder="Enter OTP"
              required
              autofocus
              style="
                margin-top: 4px;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
          </label>
          <button
            type="submit"
            class="logout"
            style="
              background: #4caf50;
              color: white;
              width: 100%;
              margin-bottom: 10px;
            "
          >
            Verify
          </button>
          <button
            type="button"
            class="logout"
            onclick="document.getElementById('otp-modal').style.display='none'"
            style="background: #666; color: white; width: 100%"
          >
            Cancel
          </button>
        </form>
      </div>
    </div>

    <script>
      let loggedInUser = null;
      let paddyMap = {}; // id -> name map for paddy types

      // Get logged in user from server session
      async function getCurrentUser() {
        try {
          const response = await fetch("/api/me");
          if (!response.ok) {
            window.location.href = "/";
            return null;
          }
          const data = await response.json();
          if (!data.ok) {
            window.location.href = "/";
            return null;
          }
          return { user_code: data.user_id };
        } catch (err) {
          console.error(err);
          window.location.href = "/";
          return null;
        }
      }

      function openTab(evt, tabName) {
        const contents = document.querySelectorAll(".tab-content");
        contents.forEach((c) => (c.style.display = "none"));
        const tabs = document.querySelectorAll(".tabs button");
        tabs.forEach((t) => t.classList.remove("active"));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.classList.add("active");

        // Load data when switching tabs
        if (tabName === "purchases") {
          loadPurchases();
        } else if (tabName === "history") {
          loadHistory();
        } else if (tabName === "stock") {
          loadStock();
        }
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "/";
      }

      // Handle source type change to populate supplier dropdown
      document
        .getElementById("source-type")
        .addEventListener("change", async function (e) {
          const sourceType = e.target.value;
          const supplierSelect = document.getElementById("supplier-select");
          supplierSelect.innerHTML = '<option value="">Loading...</option>';

          if (!sourceType) {
            supplierSelect.innerHTML =
              '<option value="">First select source type</option>';
            return;
          }

          try {
            const response = await fetch(
              `/api/users/by_type?type=${sourceType}`
            );
            if (!response.ok) throw new Error("Failed to fetch suppliers");
            const suppliers = await response.json();

            if (suppliers.length === 0) {
              supplierSelect.innerHTML =
                '<option value="">No suppliers available</option>';
              return;
            }

            supplierSelect.innerHTML =
              '<option value="">Select Supplier</option>';
            suppliers.forEach((s) => {
              const option = document.createElement("option");
              option.value = s.user_code || s.id || "";
              const userName =
                s.company_name || s.full_name || s.fullName || s.name || "";
              const userCode = s.user_code || s.id || "";
              option.textContent = userName
                ? `${userCode} - ${userName}`
                : userCode;
              supplierSelect.appendChild(option);
            });
          } catch (err) {
            console.error(err);
            alert("Error loading suppliers");
            supplierSelect.innerHTML =
              '<option value="">Error loading suppliers</option>';
          }
        });

      // Purchase Form Submit
      document
        .getElementById("purchase-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const sourceType = formData.get("sourceType");
          const supplierId = formData.get("supplierId");
          const riceTypeId = formData.get("riceType");
          const riceTypeName = paddyMap[riceTypeId] || riceTypeId;
          const quantity = parseFloat(formData.get("quantity"));
          const price = formData.get("price");

          // Store pending purchase data
          window.pendingPurchaseData = {
            from: supplierId,
            to: loggedInUser.user_code,
            type: riceTypeName,
            quantity: quantity,
            price: price ? parseFloat(price) : null,
            datetime: new Date().toISOString(),
          };

          // Fetch supplier contact to show in OTP modal
          try {
            const userRes = await fetch(`/api/users/${supplierId}`);
            const user = userRes.ok ? await userRes.json() : null;
            const phoneNumber = user?.contact_number?.slice(-4) || "****";
            document.getElementById("otp-phone-digits").textContent =
              phoneNumber;
          } catch (err) {
            console.error("Failed to fetch supplier contact", err);
            document.getElementById("otp-phone-digits").textContent = "****";
          }

          // Show OTP modal
          document.getElementById("otp-input").value = "";
          document.getElementById("otp-form").dataset.action = "purchase";
          document.getElementById("otp-modal").style.display = "flex";
        });

      // OTP Form Submit Handler
      document
        .getElementById("otp-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const otpInput = document.getElementById("otp-input").value.trim();
          const action = e.target.dataset.action || "purchase";

          // Verify OTP
          if (otpInput !== "123456") {
            alert("Invalid OTP. Please try again.");
            document.getElementById("otp-input").value = "";
            return;
          }

          // Close modal
          document.getElementById("otp-modal").style.display = "none";

          if (action === "purchase" && window.pendingPurchaseData) {
            try {
              const response = await fetch("/api/transactions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(window.pendingPurchaseData),
              });

              if (!response.ok) throw new Error("Failed to record purchase");
              alert("Purchase recorded successfully!");
              document.getElementById("purchase-form").reset();
              document.getElementById("supplier-select").innerHTML =
                '<option value="">First select source type</option>';
              window.pendingPurchaseData = null;
              loadPurchases();
              loadHistory();
            } catch (err) {
              console.error(err);
              alert("Error recording purchase");
              window.pendingPurchaseData = null;
            }
          } else if (action === "revert" && window.pendingRevertData) {
            try {
              // Use the specialized revert endpoint which handles marking the original as reverted
              const response = await fetch(
                `/api/rice_transactions/${window.pendingRevertData.id}/revert`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                }
              );

              const result = await response.json();
              if (response.ok && result.ok) {
                alert("Purchase reverted successfully!");
                window.pendingRevertData = null;
                loadPurchases();
                loadHistory();
              } else {
                alert(
                  "Error: " + (result.error || "Failed to revert purchase")
                );
                window.pendingRevertData = null;
              }
            } catch (err) {
              console.error("Failed to revert purchase:", err);
              alert("Network error: " + err.message);
              window.pendingRevertData = null;
            }
          }
        });

      let allTransactions = []; // Store all transactions for viewing

      async function loadPurchases() {
        try {
          const response = await fetch(
            `/api/transactions?user=${loggedInUser.user_code}`
          );
          if (!response.ok) throw new Error("Failed to load transactions");
          const data = await response.json();

          // Update allTransactions for the View modal
          data.forEach((t) => {
            if (!allTransactions.find((at) => at.id === t.id)) {
              allTransactions.push(t);
            }
          });

          const tbody = document.querySelector("#recent-purchases-table tbody");
          tbody.innerHTML = "";

          // Show last 5 transactions (Purchases and Reverts)
          data.slice(0, 5).forEach((t) => {
            const row = tbody.insertRow();
            const dateValue = t.datetime || t.created_at;

            // Determine if this is a purchase (user is recipient) or revert (user is sender)
            const isPurchase = t.to === loggedInUser.user_code;
            const isReverted = t.reverted === 1;

            if (isReverted) {
              row.style.backgroundColor = "#fff5f5";
            }

            // Show appropriate party name
            let displayName = isPurchase
              ? t.from_name || t.from || "Unknown"
              : t.to_name || t.to || "Unknown";

            let displayQty = isPurchase
              ? parseFloat(t.quantity)
              : -parseFloat(t.quantity);
            const qtyColor = isPurchase ? "black" : "red";

            // Only show Revert button for purchases, not if already reverted
            const showRevertBtn = isPurchase && !isReverted;
            const actionBtns = showRevertBtn
              ? `<button class="btn small" style="margin-right: 5px; padding: 4px 8px; font-size: 12px; background: #ff9800; border: none; color: white; border-radius: 4px;" onclick="viewTransaction(${
                  t.id
                })">View</button> <button class="btn small" style="padding: 4px 8px; font-size: 12px; background: #f57c00; border: none; color: white; border-radius: 4px;" onclick="showRevertOTP(${
                  t.id
                }, '${t.from}', '${t.type}', ${t.quantity}, ${
                  t.price || 0
                })">Revert</button>`
              : `<button class="btn small" style="padding: 4px 8px; font-size: 12px; background: #ff9800; border: none; color: white; border-radius: 4px;" onclick="viewTransaction(${t.id})">View</button>`;

            const revertedClass = isReverted ? "reverted-field" : "";

            row.innerHTML = `
              <td class="${revertedClass}">${
              dateValue ? new Date(dateValue).toLocaleString() : "N/A"
            }</td>
              <td class="${revertedClass}">${displayName}</td>
              <td class="${revertedClass}">${t.type}</td>
              <td class="${revertedClass}" style="color: ${
              isReverted ? "#888" : qtyColor
            };">${displayQty}</td>
              <td class="${revertedClass}">${
              t.price ? Number(t.price).toFixed(2) : "-"
            }</td>
              <td>${actionBtns}</td>
            `;
          });
        } catch (err) {
          console.error(err);
        }
      }

      async function loadHistory() {
        try {
          // Fetch both incoming and outgoing transactions
          const incomingRes = await fetch(
            `/api/transactions?to=${loggedInUser.user_code}`
          );
          if (!incomingRes.ok)
            throw new Error("Failed to load incoming transactions");
          const incomingTxs = await incomingRes.json();

          const outgoingRes = await fetch(
            `/api/transactions?from=${loggedInUser.user_code}`
          );
          if (!outgoingRes.ok)
            throw new Error("Failed to load outgoing transactions");
          const outgoingTxs = await outgoingRes.json();

          // Combine both incoming and outgoing transactions
          allTransactions = [...incomingTxs, ...outgoingTxs];

          const tbody = document.querySelector("#history-table tbody");
          tbody.innerHTML = "";

          allTransactions.forEach((t) => {
            const row = tbody.insertRow();
            const dateValue = t.datetime || t.created_at;
            const blockIdDisplay = t.block_hash
              ? t.block_hash.substring(0, 10) + "..."
              : "Not available";

            // Determine if this is a purchase (user is recipient) or revert (user is sender)
            const isPurchase = t.to === loggedInUser.user_code;
            const isReverted = t.reverted === 1;

            if (isReverted) {
              row.style.backgroundColor = "#fff5f5";
            }

            // Show appropriate party name
            let displayName = isPurchase
              ? t.from_name || t.from || "Unknown"
              : t.to_name || t.to || "Unknown";
            let displayQty = isPurchase
              ? parseFloat(t.quantity)
              : -parseFloat(t.quantity);
            const qtyColor = isPurchase ? "black" : "red";

            // Only show Revert button for purchases, not reverts, and not if already reverted
            const showRevertBtn = isPurchase && !isReverted;
            const actionBtns = showRevertBtn
              ? `<button class="btn small" style="margin-right: 5px; padding: 4px 8px; font-size: 12px; background: #ff9800;" onclick="viewTransaction(${
                  t.id
                })">View</button> <button class="btn small" style="padding: 4px 8px; font-size: 12px; background: #f57c00;" onclick="showRevertOTP(${
                  t.id
                }, '${t.from}', '${t.type}', ${t.quantity}, ${
                  t.price || 0
                })">Revert</button>`
              : `<button class="btn small" style="padding: 4px 8px; font-size: 12px; background: #ff9800;" onclick="viewTransaction(${t.id})">View</button>`;

            const revertedClass = isReverted ? "reverted-field" : "";

            row.innerHTML = `
              <td class="${revertedClass}">${
              dateValue ? new Date(dateValue).toLocaleString() : "N/A"
            }</td>
              <td class="${revertedClass}">${displayName}</td>
              <td class="${revertedClass}">${t.type}</td>
              <td class="${revertedClass}" style="color: ${
              isReverted ? "#888" : qtyColor
            };">${displayQty}</td>
              <td class="${revertedClass}">${
              t.price ? Number(t.price).toFixed(2) : "-"
            }</td>
              <td class="${revertedClass}" title="${
              t.block_hash || ""
            }">${blockIdDisplay}</td>
              <td>${actionBtns}</td>
            `;
          });
        } catch (err) {
          console.error(err);
        }
      }

      // Show OTP modal for revert
      async function showRevertOTP(id, from, type, quantity, price) {
        if (
          !confirm(
            `Revert purchase of ${quantity} kg ${type} from ${from}? This will restore stock to the supplier and deduct from yours.`
          )
        ) {
          return;
        }

        // Store pending revert data
        window.pendingRevertData = {
          id: id,
          from: from,
          to: loggedInUser.user_code,
          type: type,
          quantity: quantity,
          price: price,
          datetime: new Date().toISOString(),
          status: 0, // Revert transaction
        };

        // Fetch supplier contact to show in OTP modal
        try {
          const userRes = await fetch(`/api/users/${from}`);
          const user = userRes.ok ? await userRes.json() : null;
          const phoneNumber = user?.contact_number?.slice(-4) || "****";
          document.getElementById("otp-phone-digits").textContent = phoneNumber;
        } catch (err) {
          console.error("Failed to fetch supplier contact", err);
          document.getElementById("otp-phone-digits").textContent = "****";
        }

        // Show OTP modal
        document.getElementById("otp-input").value = "";
        document.getElementById("otp-form").dataset.action = "revert";
        document.getElementById("otp-modal").style.display = "flex";
      }

      // View transaction details function
      function viewTransaction(transactionId) {
        const t = allTransactions.find((tx) => tx.id === transactionId);

        if (!t) {
          alert("Failed to load transaction details");
          return;
        }

        const isPurchase = t.to === loggedInUser.user_code;
        const detailsHtml = `
          <p><strong>Transaction ID:</strong> ${t.id}</p>
          <p><strong>Type:</strong> <span style="color: ${
            isPurchase ? "green" : "red"
          }; font-weight: bold;">${
          isPurchase ? "PURCHASE" : "REVERT"
        }</span></p>
          <p><strong>Date/Time:</strong> ${new Date(
            t.datetime || t.created_at
          ).toLocaleString()}</p>
          <p><strong>From:</strong> ${t.from_name || t.from || "Unknown"}</p>
          <p><strong>To:</strong> ${t.to_name || t.to || "Unknown"}</p>
          <p><strong>Rice Type:</strong> ${t.type}</p>
          <p><strong>Quantity:</strong> ${
            isPurchase ? t.quantity : -t.quantity
          } kg</p>
          <p><strong>Block Number:</strong> ${
            t.block_number || "Not available"
          }</p>
          <p><strong>Transaction Hash:</strong> ${
            t.transaction_hash
              ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${t.transaction_hash}</span>`
              : "Not available"
          }</p>
          <p><strong>Block Hash:</strong> ${
            t.block_hash
              ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${t.block_hash}</span>`
              : "Not available"
          }</p>
        `;
        document.getElementById("transactionDetails").innerHTML = detailsHtml;
        document.getElementById("transactionModal").style.display = "flex";
      }

      // Close transaction modal
      function closeTransactionModal() {
        document.getElementById("transactionModal").style.display = "none";
      }

      // Close modal when clicking outside
      document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("transactionModal");
        if (modal) {
          modal.addEventListener("click", function (e) {
            if (e.target === this) {
              closeTransactionModal();
            }
          });
        }
      });

      // Revert transaction function
      async function revertTransaction(transactionId) {
        if (
          !confirm(
            "Are you sure you want to revert this rice purchase? This will restore stock to the supplier and deduct from yours."
          )
        ) {
          return;
        }

        try {
          console.log(`Reverting rice transaction: ${transactionId}`);
          const resp = await fetch(
            `/api/rice_transactions/${transactionId}/revert`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            }
          );

          if (!resp.ok) {
            const errData = await resp.json();
            throw new Error(errData.error || "Failed to revert purchase");
          }

          const respData = await resp.json();

          if (respData.ok) {
            alert(
              `âœ“ Rice Purchase reverted successfully!\nBlock Hash: ${
                respData.block_hash
                  ? respData.block_hash.substring(0, 10) + "..."
                  : "Processing..."
              }`
            );
          } else {
            alert(
              `âš  Revert saved but blockchain recording may have failed: ${
                respData.error || "Unknown error"
              }`
            );
          }

          loadHistory();
        } catch (err) {
          console.error("Error reverting purchase", err);
          alert("Error reverting purchase: " + err.message);
        }
      }

      async function loadStock() {
        try {
          const response = await fetch(
            `/api/stock_by_type?kind=rice&user_id=${encodeURIComponent(
              loggedInUser.user_code
            )}`
          );
          if (!response.ok) throw new Error("Failed to load stock");
          const data = await response.json();
          renderStockTable(data);
        } catch (err) {
          console.error(err);
        }
      }

      function renderStockTable(stocks) {
        const tbody = document.querySelector("#stock-table tbody");
        tbody.innerHTML = "";
        if (!stocks || stocks.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='2' style='text-align: center; color: #999;'>No rice stock available</td></tr>";
          return;
        }
        stocks.forEach((stock) => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${stock.paddy_type || "Unknown"}</td>
            <td>${parseFloat(stock.quantity || 0).toFixed(2)}</td>
          `;
        });
      }

      // Initial load
      (async function () {
        try {
          const ptRes = await fetch("/api/paddy_types");
          if (ptRes.ok) {
            const pts = await ptRes.json();
            pts.forEach((p) => {
              paddyMap[p.id] = p.name;
            });
            const selects = document.querySelectorAll(
              'select[name="riceType"]'
            );
            selects.forEach((sel) => {
              sel.innerHTML = '<option value="">Select Rice Type</option>';
              pts.forEach((p) => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.name;
                sel.appendChild(opt);
              });
            });
          }
        } catch (err) {
          console.warn("Failed to load paddy types", err);
        }

        loggedInUser = await getCurrentUser();
        if (loggedInUser) {
          loadPurchases();
        }
      })();
    </script>
  </body>
</html>
