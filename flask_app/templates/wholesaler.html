<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wholesaler - Sri Lanka Rice Supply Chain</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
      }

      /* Header Styles */
      header.site-header {
        position: relative;
        background: linear-gradient(135deg, #1e40af 0%, #1e5a96 100%);
        color: white;
        padding: 30px 20px;
        box-shadow: 0 10px 30px rgba(30, 64, 175, 0.2);
      }

      .site-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 24px;
        color: white;
      }

      /* Logout button styles */
      .logout-top {
        position: absolute;
        top: 18px;
        right: 18px;
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.12);
        padding: 8px 12px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .logout-top:hover {
        background: white;
        color: #1e40af;
        border-color: white;
      }

      /* Tab Navigation */
      .tabs {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .tabs ul {
        list-style: none;
        padding: 0;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .tab a {
        display: inline-block;
        padding: 10px 24px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        border: 2px solid transparent;
      }

      .tab a:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .tab.active a {
        background: white;
        color: #1e40af;
        border-color: white;
        font-weight: 600;
      }

      /* Main Content */
      main.content {
        padding: 32px 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .panel {
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .panel h2 {
        font-size: 28px;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 24px;
      }

      .panel h3 {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin-top: 32px !important;
        margin-bottom: 16px;
      }

      /* Card Styles */
      .card {
        background: white;
        border-radius: 12px;
        padding: 28px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }

      .card form {
        display: grid;
        gap: 16px;
      }

      label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      input[type="text"],
      input[type="number"],
      input[type="date"],
      select,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-family: inherit;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f9fafb;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="date"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        background: white;
        border-color: #1e40af;
        box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      input::placeholder,
      textarea::placeholder {
        color: #9ca3af;
      }

      /* Modal Actions */
      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-start;
        margin-top: 24px;
      }

      /* Button Styles */
      .btn {
        display: inline-block;
        padding: 12px 24px;
        background: #e5e7eb;
        color: #1f2937;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        font-size: 14px;
        text-align: center;
      }

      .btn:hover {
        background: #d1d5db;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn.primary {
        background: linear-gradient(135deg, #1e40af 0%, #1e5a96 100%);
        color: white;
      }

      .btn.primary:hover {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e4675 100%);
      }

      /* Table Styles */
      .table-wrap {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
      }

      .data-table thead {
        background: linear-gradient(135deg, #1e40af 0%, #1e5a96 100%);
        color: white;
      }

      .data-table th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #1e40af;
      }

      .data-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #e5e7eb;
      }

      .data-table tbody tr {
        transition: all 0.2s ease;
      }

      .data-table tbody tr:hover {
        background: #f9fafb;
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .tabs ul {
          flex-direction: column;
        }

        .tab a {
          width: 100%;
          text-align: center;
        }

        .modal-actions {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .data-table {
          font-size: 12px;
        }

        .data-table th,
        .data-table td {
          padding: 10px 8px;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <h1 class="site-title">üè™ Wholesaler Dashboard</h1>
      <a href="/logout" class="logout-top">üîí Logout</a>
      <nav class="tabs" aria-label="Wholesaler tabs">
        <ul>
          <li class="tab active">
            <a href="#" data-index="0">üì¶ Purchases</a>
          </li>
          <li class="tab"><a href="#" data-index="1">‚ö†Ô∏è Damage</a></li>
          <li class="tab"><a href="#" data-index="2">üåæ Rice Stock</a></li>
        </ul>
      </nav>
    </header>

    <main class="content">
      <section class="panel" id="purchases-panel">
        <h2>üì¶ Record Rice Purchase</h2>

        <div class="card">
          <form id="purchaseForm">
            <label for="purchaseFromType">Purchase From</label>
            <select id="purchaseFromType" required>
              <option value="Miller">Miller</option>
              <option value="PMB">PMB</option>
            </select>

            <label for="millerSelect">Source</label>
            <select id="millerSelect" required>
              <option value="">Loading...</option>
            </select>

            <label for="riceType">Rice Type (Paddy Base)</label>
            <select id="riceType" required>
              <option value="">Select rice type</option>
            </select>

            <label for="qty">Quantity (kg)</label>
            <input id="qty" type="number" min="0" step="0.01" required />

            <label for="price">Price (per kg)</label>
            <input id="price" type="number" min="0" step="0.01" />

            <div class="modal-actions">
              <button type="submit" class="btn primary">
                üíæ Record Rice Purchase
              </button>
            </div>
          </form>
        </div>

        <h3 style="margin-top: 18px">Recent Purchases</h3>
        <div class="table-wrap">
          <table class="data-table" id="purchasesTable">
            <thead>
              <tr>
                <th>When</th>
                <th>Miller</th>
                <th>Rice Type</th>
                <th>Qty (kg)</th>
                <th>Price (per kg)</th>
                <th>Block ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel" id="damage-panel" hidden>
        <h2>‚ö†Ô∏è Record Damaged Rice</h2>

        <div class="card">
          <form id="damageForm">
            <label for="damageRiceType">Rice Type</label>
            <select id="damageRiceType" required>
              <option value="">Select rice type</option>
            </select>

            <label for="damageQty">Quantity (kg)</label>
            <input id="damageQty" type="number" min="0" step="0.01" required />

            <label for="damageReason">Reason</label>
            <textarea id="damageReason" rows="3" required></textarea>

            <label for="damageDate">Date</label>
            <input id="damageDate" type="date" required />

            <div class="modal-actions">
              <button type="submit" class="btn primary">üíæ Save Damage</button>
            </div>
          </form>
        </div>

        <h3 style="margin-top: 18px">Damage Records</h3>
        <div class="table-wrap">
          <table class="data-table" id="damagesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Rice Type</th>
                <th>Qty (kg)</th>
                <th>Reason</th>
                <th>Block ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section class="panel" id="ricestock-panel" hidden>
        <h2>üåæ Rice Stock</h2>
        <div class="table-wrap">
          <table class="data-table" id="riceStockTable">
            <thead>
              <tr>
                <th>Rice Type</th>
                <th>Quantity (kg)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </main>

    <!-- Modal for viewing rice purchase details -->
    <div
      id="purchaseModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        "
      >
        <h2>Rice Purchase Details</h2>
        <div id="purchaseDetails" style="margin: 20px 0">
          <!-- Details will be populated here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button class="btn primary" onclick="closePurchaseModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- OTP Verification Modal -->
    <div
      id="otp-verification-modal"
      style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          z-index: 1002;
        "
      >
        <h2>Verify OTP</h2>
        <p style="margin: 15px 0; color: #666">
          Enter the OTP sent to
          <strong>****<span id="otp-phone-digits"></span></strong>
        </p>
        <form id="otp-verification-form">
          <input
            type="password"
            id="otp-input-field"
            placeholder="Enter OTP"
            required
            autofocus
            style="
              width: 100%;
              padding: 10px;
              margin: 10px 0;
              border: 1px solid #ddd;
              border-radius: 4px;
              font-size: 16px;
              box-sizing: border-box;
            "
          />
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button type="submit" class="btn primary" style="flex: 1">
              Verify
            </button>
            <button
              type="button"
              id="close-otp-modal"
              class="btn secondary"
              style="flex: 1"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for viewing damage details -->
    <div
      id="damageModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 8px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        "
      >
        <h2>Damage Record Details</h2>
        <div id="damageDetails" style="margin: 20px 0">
          <!-- Details will be populated here -->
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px">
          <button class="btn primary" onclick="closeDamageModal()">
            Close
          </button>
        </div>
      </div>
    </div>

    <script>
      // Wholesaler purchases UI (server-backed)
      let purchases = [];
      let sales = [];
      let damages = [];
      let currentUser = null;

      function qs(sel) {
        return document.querySelector(sel);
      }

      async function fetchMillers() {
        try {
          const res = await fetch("/api/users/by_type?type=Miller");
          if (!res.ok) throw new Error("Failed to load millers");
          const data = await res.json();
          console.log("Fetched millers data:", data);
          return Array.isArray(data) ? data : [];
        } catch (e) {
          console.error("Could not fetch millers:", e);
          return [];
        }
      }

      async function fetchPaddyTypes() {
        try {
          const res = await fetch("/api/paddy_types");
          if (!res.ok) throw new Error("Failed to load paddy types");
          const data = await res.json();
          return Array.isArray(data) ? data : [];
        } catch (e) {
          console.error("Could not fetch paddy types:", e);
          return [];
        }
      }

      async function fetchCurrentUser() {
        try {
          const res = await fetch("/api/me");
          if (!res.ok) return null;
          const j = await res.json();
          return j && j.ok ? j : null;
        } catch (e) {
          console.error("Could not fetch current user", e);
          return null;
        }
      }

      async function populateMillerSelect(sourceType) {
        const sel = qs("#millerSelect");
        sel.innerHTML = "";
        const ph = document.createElement("option");
        ph.value = "";

        if (sourceType === "PMB") {
          // For PMB, just show PMB option
          ph.textContent = "Select PMB";
          sel.appendChild(ph);
          const pmbOpt = document.createElement("option");
          pmbOpt.value = "PMB";
          pmbOpt.textContent = "Government (PMB)";
          sel.appendChild(pmbOpt);
        } else {
          // For Miller, fetch and show all millers
          const millers = await fetchMillers();
          ph.textContent = "Select miller";
          sel.appendChild(ph);
          millers.forEach((m) => {
            const o = document.createElement("option");
            o.value = m.id;
            const millerName =
              m.company_name?.trim() ||
              m.full_name?.trim() ||
              m.name?.trim() ||
              "";
            console.log("Miller object:", m);
            console.log("Miller name being used:", millerName);
            // Show Miller ID, and if name exists, add it after a dash
            o.textContent = millerName
              ? (m.id || "") + " - " + millerName
              : m.id || "";
            sel.appendChild(o);
          });
        }
      }

      async function loadServerTransactions() {
        try {
          const userId = currentUser ? currentUser.user_id : null;
          if (!userId) return;

          // Fetch all transactions where user is either from or to (includes purchases and reversions)
          const res = await fetch(
            `/api/transactions?user=${encodeURIComponent(userId)}`
          );
          if (!res.ok) throw new Error("Failed to load transactions");
          const txs = await res.json();

          purchases = txs.map((t) => ({
            id: t.id,
            when: t.datetime || t.created_at,
            from: t.from,
            to: t.to,
            fromName: t.from_name || t.from || "Unknown",
            toName: t.to_name || t.to || "Unknown",
            riceType: t.type,
            qty: parseFloat(t.quantity) || 0,
            price: t.price ? parseFloat(t.price) : null,
            tx_id: t.id,
            block_hash: t.block_hash || null,
            block_number: t.block_number || null,
            transaction_hash: t.transaction_hash || null,
            status: t.reverted === 1 ? 0 : 1, // Map reverted to status for display consistency
            reverted: t.reverted || 0,
          }));
        } catch (e) {
          console.error("Could not load server transactions", e);
          purchases = [];
        }
      }

      function renderPurchaseTables() {
        const pBody = qs("#purchasesTable tbody");
        const userId = currentUser ? currentUser.user_id : null;
        pBody.innerHTML = "";

        const recent = purchases.slice().reverse().slice(0, 10);
        recent.forEach((r) => {
          const tr = document.createElement("tr");
          const blockIdDisplay = r.block_hash
            ? r.block_hash.substring(0, 10) + "..."
            : "Not available";
          const priceDisplay = r.price ? r.price.toFixed(2) : "-";

          // Determine if this is a purchase (user is recipient) or revert (user is sender)
          const isPurchase = r.to === userId;
          const isRevert = r.from === userId && r.status === 0;

          // Highlight reverted rows (status = 0)
          if (
            r.status === 0 ||
            r.status === false ||
            r.status === "0" ||
            r.status === null
          ) {
            tr.style.backgroundColor = "#fee2e2"; // Light red background
            tr.style.opacity = "0.7";
          }

          // Show appropriate party name and action buttons
          let displayName = isPurchase ? r.fromName : r.toName;
          let displayQty = isPurchase ? r.qty : -r.qty;
          let actionBtns = `<button class="btn small" onclick="viewPurchase(event, ${r.tx_id})">View</button>`;
          if (isPurchase && r.status !== 0) {
            actionBtns += ` <button class="btn small" style="background-color: #ef4444; color: white;" onclick="revertPurchase(event, ${r.tx_id}, '${r.id}')">Revert</button>`;
          }

          const qtyColor = isPurchase ? "black" : "red";
          const statusDisplay =
            r.status === 0
              ? '<span style="color: red; font-weight: bold;">Reverted</span>'
              : '<span style="color: green; font-weight: bold;">Normal</span>';
          tr.innerHTML = `<td>${new Date(
            r.when
          ).toLocaleString()}</td><td>${displayName}</td><td>${
            r.riceType
          }</td><td style="color: ${qtyColor};">${displayQty}</td><td>${priceDisplay}</td><td title="${
            r.block_hash || ""
          }">${blockIdDisplay}</td><td>${actionBtns}</td>`;
          pBody.appendChild(tr);
        });
      }

      async function renderDamageTable() {
        const dBody = qs("#damagesTable tbody");
        dBody.innerHTML = "";
        try {
          const userId = currentUser ? currentUser.user_id : null;
          const url = userId
            ? `/api/damages?user_id=${encodeURIComponent(userId)}`
            : "/api/damages";
          const res = await fetch(url);
          if (!res.ok) throw new Error("Failed to load damages");
          damages = await res.json();
          damages.forEach((d) => {
            const tr = document.createElement("tr");
            const displayDate = d.damage_date || d.created_at;
            const blockIdDisplay = d.block_hash
              ? d.block_hash.substring(0, 10) + "..."
              : "Not available";

            // Highlight reverted rows (status = 0 or reverted = 1)
            if (
              d.status === 0 ||
              d.status === false ||
              d.status === "0" ||
              d.status === null ||
              d.reverted === 1
            ) {
              tr.style.backgroundColor = "#fee2e2"; // Light red background
              tr.style.opacity = "0.7";
            }

            const actionBtns = `<button class="btn small" onclick="viewDamage(event, ${
              d.id
            })">View</button>${
              d.status !== 0 && d.reverted !== 1
                ? ` <button class="btn small" style="background-color: #ef4444; color: white;" onclick="revertDamage(${d.id})">Revert</button>`
                : ""
            }`;
            tr.innerHTML = `<td>${new Date(displayDate).toLocaleString()}</td>
                          <td>${d.paddy_type}</td>
                          <td>${d.quantity}</td>
                          <td>${d.reason}</td>
                          <td title="${
                            d.block_hash || ""
                          }">${blockIdDisplay}</td><td>${actionBtns}</td>`;
            dBody.appendChild(tr);
          });
        } catch (e) {
          console.error("Could not load damages:", e);
        }
      }

      function setupTabs() {
        const tabs = Array.from(document.querySelectorAll(".tabs .tab"));
        const panels = [
          qs("#purchases-panel"),
          qs("#damage-panel"),
          qs("#ricestock-panel"),
        ];
        tabs.forEach((tab, i) => {
          tab.addEventListener("click", (ev) => {
            ev.preventDefault();
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");
            panels.forEach((p) => (p.hidden = true));
            panels[i].hidden = false;
            // Load rice stock when switching to rice stock tab
            if (i === 2) {
              loadRiceStock();
            }
          });
        });
      }

      function setupHistoryTabs() {
        // History tabs functionality removed - only purchase history available
      }

      async function loadRiceStock() {
        try {
          const res = await fetch(
            `/api/stock_by_type?kind=rice&user_id=${encodeURIComponent(
              currentUser.user_id
            )}`
          );
          if (!res.ok) throw new Error("Failed to fetch rice stock");
          const data = await res.json();
          renderRiceStockTable(data);
        } catch (err) {
          console.error("Error loading rice stock:", err);
        }
      }

      function renderRiceStockTable(stocks) {
        const tbody = qs("#riceStockTable tbody");
        tbody.innerHTML = "";
        if (!stocks || stocks.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='2' style='text-align: center; color: #999;'>No rice stock available</td></tr>";
          return;
        }
        stocks.forEach((stock) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${stock.paddy_type || "Unknown"}</td>
            <td>${parseFloat(stock.quantity || 0).toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });
      }

      async function init() {
        setupTabs();

        const me = await fetchCurrentUser();
        if (!me) {
          window.location = "/";
          return;
        }
        currentUser = me;
        console.log("Current user (wholesaler):", currentUser);

        const fromTypeSel = qs("#purchaseFromType");
        await populateMillerSelect(fromTypeSel.value);

        // Listen for purchase type changes
        fromTypeSel.addEventListener("change", (e) => {
          populateMillerSelect(e.target.value);
        });

        // Populate rice type dropdowns
        const types = await fetchPaddyTypes();
        const selectors = ["#riceType", "#saleRiceType", "#damageRiceType"];
        selectors.forEach((selId) => {
          const sel = qs(selId);
          if (sel) {
            sel.innerHTML = "";
            const ph = document.createElement("option");
            ph.value = "";
            ph.textContent = "Select rice type";
            sel.appendChild(ph);
            types.forEach((t) => {
              const o = document.createElement("option");
              o.value = t.name || t.id || "";
              o.textContent = t.name || String(t.id || "");
              sel.appendChild(o);
            });
          }
        });

        // Set default dates
        const today = new Date().toISOString().split("T")[0];
        if (qs("#saleDate")) qs("#saleDate").value = today;
        if (qs("#damageDate")) qs("#damageDate").value = today;

        await loadServerTransactions();
        renderPurchaseTables();

        // Purchase form handler (Record Rice Purchase with Blockchain)
        qs("#purchaseForm").addEventListener("submit", async (ev) => {
          ev.preventDefault();
          const millerId = qs("#millerSelect").value;
          const millerName =
            qs("#millerSelect").selectedOptions[0]?.textContent || "";
          const riceType = qs("#riceType").value;
          const qty = qs("#qty").value;
          const price = qs("#price").value;

          if (!millerId || !riceType || !qty) {
            alert("Please fill all fields");
            return;
          }

          // Store purchase data for OTP verification
          window.pendingPurchaseData = {
            from: millerId,
            type: riceType,
            quantity: parseFloat(qty),
            price: price ? parseFloat(price) : null,
          };

          // Fetch miller details to get phone number
          (async () => {
            try {
              const res = await fetch(
                `/api/users/${encodeURIComponent(millerId)}`
              );
              const user = res.ok ? await res.json() : null;
              let phoneNumber = "****";
              if (user && user.contact_number) {
                const phone = String(user.contact_number).trim();
                if (phone.length >= 4) {
                  phoneNumber = phone.slice(-4);
                }
              }

              // Show OTP modal for purchase verification with phone number
              const otpModal = document.getElementById(
                "otp-verification-modal"
              );
              document.getElementById("otp-phone-digits").textContent =
                phoneNumber;
              document.getElementById("otp-input-field").value = "";
              document.getElementById("otp-verification-form").dataset.action =
                "purchase";
              otpModal.style.display = "flex";
            } catch (err) {
              console.error("Failed to fetch user details:", err);
              // Fallback: show OTP modal anyway
              const otpModal = document.getElementById(
                "otp-verification-modal"
              );
              document.getElementById("otp-phone-digits").textContent = "****";
              document.getElementById("otp-input-field").value = "";
              document.getElementById("otp-verification-form").dataset.action =
                "purchase";
              otpModal.style.display = "flex";
            }
          })();
        });

        // Revert rice purchase function
        window.revertPurchase = async function (transactionId) {
          if (
            !confirm(
              "Are you sure you want to revert this rice purchase? This will restore stock to the seller and deduct from yours."
            )
          ) {
            return;
          }

          try {
            console.log(`Reverting rice transaction: ${transactionId}`);
            const resp = await fetch(
              `/api/rice_transactions/${transactionId}/revert`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );

            if (!resp.ok) {
              const errData = await resp.json();
              throw new Error(errData.error || "Failed to revert purchase");
            }

            const respData = await resp.json();

            if (respData.ok) {
              alert(
                `‚úì Rice Purchase reverted successfully!\nBlock Hash: ${
                  respData.block_hash
                    ? respData.block_hash.substring(0, 10) + "..."
                    : "Processing..."
                }`
              );
            } else {
              alert(
                `‚ö† Revert saved but blockchain recording may have failed: ${
                  respData.error || "Unknown error"
                }`
              );
            }

            await loadServerTransactions();
            renderPurchaseTables();
          } catch (err) {
            console.error("Error reverting purchase", err);
            alert("Error reverting purchase: " + err.message);
          }
        };

        // View rice purchase details function
        window.viewPurchase = function (event, transactionId) {
          event.preventDefault();
          event.stopPropagation();

          const userId = currentUser ? currentUser.user_id : null;
          const purchase = purchases.find((p) => p.tx_id === transactionId);
          if (!purchase) {
            alert("Purchase details not found");
            return;
          }

          // Determine if this is a purchase or a revert
          const isPurchase = purchase.to === userId;
          const isRevert = purchase.from === userId && purchase.status === 0;

          const detailsHtml = `
            <div style="font-size: 14px; line-height: 1.8;">
              <p><strong>Transaction ID:</strong> ${purchase.tx_id}</p>
              <p><strong>Date/Time:</strong> ${new Date(
                purchase.when
              ).toLocaleString()}</p>
              <p><strong>From:</strong> ${purchase.fromName}</p>
              <p><strong>Rice Type:</strong> ${purchase.riceType}</p>
              <p><strong>Quantity:</strong> ${
                isPurchase ? purchase.qty : -purchase.qty
              } kg</p>
              <p><strong>Block Number:</strong> ${
                purchase.block_number || "Not available"
              }</p>
              <p><strong>Transaction Hash:</strong> ${
                purchase.transaction_hash
                  ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${purchase.transaction_hash}</span>`
                  : "Not available"
              }</p>
              <p><strong>Block Hash:</strong> ${
                purchase.block_hash
                  ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${purchase.block_hash}</span>`
                  : "Not available"
              }</p>
            </div>
          `;

          qs("#purchaseDetails").innerHTML = detailsHtml;
          qs("#purchaseModal").style.display = "flex";
        };

        // Close purchase modal
        window.closePurchaseModal = function () {
          qs("#purchaseModal").style.display = "none";
        };

        // Close modal when clicking outside
        qs("#purchaseModal").addEventListener("click", function (e) {
          if (e.target === this) {
            closePurchaseModal();
          }
        });

        // Revert rice purchase function
        window.revertPurchase = function (event, transactionId, recordId) {
          event.preventDefault();
          event.stopPropagation();

          const userId = currentUser ? currentUser.user_id : null;
          const purchase = purchases.find((p) => p.tx_id === transactionId);
          if (!purchase) {
            alert("Purchase details not found");
            return;
          }

          // Store revert data for OTP verification
          window.pendingRevertData = {
            transactionId: transactionId,
            recordId: recordId, // Original transaction record ID
            from: purchase.from,
            to: purchase.to,
            quantity: purchase.qty,
            riceType: purchase.riceType,
            price: purchase.price,
          };

          // Fetch user (wholesaler) contact number for OTP
          (async () => {
            try {
              const res = await fetch(
                `/api/users/${encodeURIComponent(userId)}`
              );
              const user = res.ok ? await res.json() : null;
              let phoneNumber = "****";
              if (user && user.contact_number) {
                const phone = String(user.contact_number).trim();
                if (phone.length >= 4) {
                  phoneNumber = phone.slice(-4);
                }
              }

              // Show OTP modal for revert verification
              const otpModal = document.getElementById(
                "otp-verification-modal"
              );
              document.getElementById("otp-phone-digits").textContent =
                phoneNumber;
              document.getElementById("otp-input-field").value = "";
              document.getElementById("otp-verification-form").dataset.action =
                "revert";
              otpModal.style.display = "flex";
            } catch (err) {
              console.error("Failed to fetch user details:", err);
              // Fallback: show OTP modal anyway
              const otpModal = document.getElementById(
                "otp-verification-modal"
              );
              document.getElementById("otp-phone-digits").textContent = "****";
              document.getElementById("otp-input-field").value = "";
              document.getElementById("otp-verification-form").dataset.action =
                "revert";
              otpModal.style.display = "flex";
            }
          })();
        };

        // View damage details function
        window.viewDamage = function (event, damageId) {
          event.preventDefault();
          event.stopPropagation();

          const damage = damages.find((d) => d.id === damageId);
          if (!damage) {
            alert("Damage details not found");
            return;
          }

          const detailsHtml = `
            <div style="font-size: 14px; line-height: 1.8;">
              <p><strong>Damage ID:</strong> ${damage.id}</p>
              <p><strong>Date/Time:</strong> ${new Date(
                damage.damage_date || damage.created_at
              ).toLocaleString()}</p>
              <p><strong>Rice Type:</strong> ${damage.paddy_type}</p>
              <p><strong>Quantity:</strong> ${damage.quantity} kg</p>
              <p><strong>Reason:</strong> ${damage.reason}</p>
              <p><strong>Block Number:</strong> ${
                damage.block_number || "Not available"
              }</p>
              <p><strong>Transaction Hash:</strong> ${
                damage.transaction_hash
                  ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${damage.transaction_hash}</span>`
                  : "Not available"
              }</p>
              <p><strong>Block Hash:</strong> ${
                damage.block_hash
                  ? `<span style="word-break: break-all; font-family: monospace; font-size: 12px;">${damage.block_hash}</span>`
                  : "Not available"
              }</p>
            </div>
          `;

          qs("#damageDetails").innerHTML = detailsHtml;
          qs("#damageModal").style.display = "flex";
        };

        // Close damage modal
        window.closeDamageModal = function () {
          qs("#damageModal").style.display = "none";
        };

        // Close modal when clicking outside
        qs("#damageModal").addEventListener("click", function (e) {
          if (e.target === this) {
            closeDamageModal();
          }
        });

        // Revert damage record function
        window.revertDamage = async function (damageId) {
          // Find the damage record to get its kind (rice or paddy)
          const damageRecord = damages.find((d) => d.id === damageId);
          if (!damageRecord) {
            alert("Damage record not found");
            return;
          }

          if (
            !confirm(
              "Are you sure you want to revert this damage record? This will restore the rice quantity to your stock."
            )
          ) {
            return;
          }

          try {
            console.log(`Reverting damage record: ${damageId}`);
            const kind = damageRecord.kind || "rice"; // Default to rice if not specified
            const resp = await fetch(
              `/api/damages/${damageId}/revert?kind=${kind}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
              }
            );

            if (!resp.ok) {
              const errData = await resp.json();
              throw new Error(errData.error || "Failed to revert damage");
            }

            const respData = await resp.json();

            if (respData.ok) {
              alert(
                `‚úì Damage record reverted successfully!\nBlock Hash: ${
                  respData.block_hash
                    ? respData.block_hash.substring(0, 10) + "..."
                    : "Processing..."
                }`
              );
            } else {
              alert(
                `‚ö† Revert saved but blockchain recording may have failed: ${
                  respData.error || "Unknown error"
                }`
              );
            }

            await renderDamageTable();
          } catch (err) {
            console.error("Error reverting damage", err);
            alert("Error reverting damage: " + err.message);
          }
        };

        // Sales form removed: form submission handled elsewhere or disabled

        // Damage form handler
        qs("#otp-verification-form").addEventListener("submit", async (ev) => {
          ev.preventDefault();
          const otpInput = qs("#otp-input-field").value;
          const otpModal = qs("#otp-verification-modal");
          const action =
            qs("#otp-verification-form").dataset.action || "purchase";

          // Verify OTP
          if (otpInput !== "123456") {
            alert("Invalid OTP. Transaction cancelled.");
            otpModal.style.display = "none";
            window.pendingPurchaseData = null;
            window.pendingRevertData = null;
            return;
          }

          otpModal.style.display = "none";

          // Handle purchase action
          if (action === "purchase") {
            // OTP verified - proceed with purchase
            const data = window.pendingPurchaseData;
            if (!data) {
              alert("No pending purchase data");
              return;
            }

            try {
              console.log(
                `Recording Rice Purchase: From=${data.from}, To=${currentUser.user_id}, Type=${data.type}, Qty=${data.quantity}`
              );
              const payload = {
                from: data.from,
                to: currentUser.user_id,
                type: data.type,
                quantity: data.quantity,
                price: data.price,
                datetime: new Date().toISOString(),
              };
              const resp = await fetch("/api/transactions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) {
                const errData = await resp.json();
                throw new Error(errData.error || "Failed to save purchase");
              }
              const respData = await resp.json();

              if (respData.ok) {
                alert(
                  `‚úì Rice Purchase recorded successfully!\nBlock Hash: ${
                    respData.block_hash
                      ? respData.block_hash.substring(0, 10) + "..."
                      : "Processing..."
                  }`
                );
              } else {
                alert(
                  `‚ö† Purchase saved but blockchain recording may have failed: ${
                    respData.error || "Unknown error"
                  }`
                );
              }

              qs("#purchaseForm").reset();
              await loadServerTransactions();
              renderPurchaseTables();
              window.pendingPurchaseData = null;
            } catch (err) {
              console.error("Error saving purchase", err);
              alert("Error saving purchase: " + err.message);
            }
          }
          // Handle revert action
          else if (action === "revert") {
            const data = window.pendingRevertData;
            if (!data) {
              alert("No pending revert data");
              return;
            }

            try {
              console.log(
                `Reverting Rice Purchase: Transaction ID=${data.transactionId}, Record ID=${data.recordId}`
              );
              const payload = {
                from: data.from,
                to: data.to,
                type: data.riceType,
                quantity: data.quantity,
                price: data.price,
                datetime: new Date().toISOString(),
                status: 0,
                original_transaction_id: data.recordId, // Mark the original transaction to be updated
              };

              console.log("Revert payload:", payload);

              const resp = await fetch("/api/transactions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });
              if (!resp.ok) {
                const errData = await resp.json();
                throw new Error(errData.error || "Failed to revert purchase");
              }
              const respData = await resp.json();

              if (respData.ok) {
                alert(
                  `‚úì Rice Purchase reverted successfully!\nBlock Hash: ${
                    respData.block_hash
                      ? respData.block_hash.substring(0, 10) + "..."
                      : "Processing..."
                  }`
                );
              } else {
                alert(
                  `‚ö† Revert saved but blockchain recording may have failed: ${
                    respData.error || "Unknown error"
                  }`
                );
              }

              await loadServerTransactions();
              renderPurchaseTables();
              window.pendingRevertData = null;
            } catch (err) {
              console.error("Error reverting purchase", err);
              alert("Error reverting purchase: " + err.message);
            }
          }
        });

        // Close OTP modal button
        qs("#close-otp-modal")?.addEventListener("click", () => {
          qs("#otp-verification-modal").style.display = "none";
          window.pendingPurchaseData = null;
        });

        qs("#damageForm").addEventListener("submit", async (ev) => {
          ev.preventDefault();
          const riceType = qs("#damageRiceType").value;
          const qty = qs("#damageQty").value;
          const reason = qs("#damageReason").value;
          const date = qs("#damageDate").value;

          if (!riceType || !qty || !reason || !date) {
            alert("Please fill all fields");
            return;
          }

          try {
            const payload = {
              user_id: currentUser.user_id,
              paddy_type: riceType,
              quantity: parseFloat(qty),
              reason,
              damage_date: date,
            };
            const resp = await fetch("/api/damages", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            if (!resp.ok) throw new Error("Failed to save damage");
            alert("Damage record saved successfully");
            qs("#damageForm").reset();
            await renderDamageTable();
          } catch (err) {
            console.error("Error saving damage", err);
            alert("Error saving damage");
          }
        });

        await renderDamageTable();
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
